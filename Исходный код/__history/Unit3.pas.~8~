unit Unit3;

interface

uses
    Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
    Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Grids;

type
    TForm3 = class(TForm)
        ComboBox1: TComboBox;
        Label1: TLabel;
        Button1: TButton;
        Label2: TLabel;
        Edit1: TEdit;
        Label3: TLabel;
        Edit2: TEdit;
        Button2: TButton;
        Button3: TButton;
        Button4: TButton;
        StringGrid: TStringGrid;
        OpenDialog: TOpenDialog;
        SaveDialog1: TSaveDialog;
        Button5: TButton;
        procedure Button2Click(Sender: TObject);
        procedure ComboBox1Change(Sender: TObject);
        procedure Edit1Change(Sender: TObject);
        procedure Button4Click(Sender: TObject);
        procedure Button3Click(Sender: TObject);
        procedure Button1Click(Sender: TObject);
        procedure Button5Click(Sender: TObject);
    private
        function EncryptRailFence(const Source: string; NumRows: Integer): string;
        function DecryptRailFence(const Source: string; NumRows: Integer): string;
        function GetEnglishUpper(const S: string): string;
    public
    end;

var
    Form3: TForm3;

implementation

{$R *.dfm}


function TForm3.GetEnglishUpper(const S: string): string;
var
    i: Integer;
    T: string;
begin
    T := UpperCase(S);
    Result := '';

    for i := 1 to Length(T) do
        if CharInSet(T[i], ['A'..'Z']) then
            Result := Result + T[i];
end;


function TForm3.EncryptRailFence(const Source: string; NumRows: Integer): string;
var
    EnglishText: string;
    Row, Col, CharIndex: Integer;
    DirDown: Boolean;
begin
    EnglishText := GetEnglishUpper(Source);

    if EnglishText = '' then
        Exit('');

    StringGrid.RowCount := NumRows;
    StringGrid.ColCount := Length(EnglishText);

    for Col := 0 to StringGrid.ColCount - 1 do
        for Row := 0 to StringGrid.RowCount - 1 do
            StringGrid.Cells[Col, Row] := '';

    if NumRows = 1 then
    begin
        for CharIndex := 1 to Length(EnglishText) do
            StringGrid.Cells[CharIndex - 1, 0] := EnglishText[CharIndex];
    end
    else
    begin
        Row := 0;
        Col := 0;
        CharIndex := 1;
        DirDown := True;

        while Col < StringGrid.ColCount do
        begin
            if CharIndex <= Length(EnglishText) then
                StringGrid.Cells[Col, Row] := EnglishText[CharIndex];

            Inc(CharIndex);

            if DirDown then
                Inc(Row)
            else
                Dec(Row);

            if Row = NumRows - 1 then
                DirDown := False
            else if Row = 0 then
                DirDown := True;

            Inc(Col);
        end;
    end;

    Result := '';

    for Row := 0 to StringGrid.RowCount - 1 do
        for Col := 0 to StringGrid.ColCount - 1 do
            if StringGrid.Cells[Col, Row] <> '' then
                Result := Result + StringGrid.Cells[Col, Row];

end;


Function TForm3.DecryptRailFence(Const Source: String; NumRows: Integer): String;
Var
    EnglishEncrypted: String;
    Rail: Array of Array of Char;
    Row, Col, Index: Integer;
    DirDown: Boolean;
    NumCols: Integer;
Begin
    EnglishEncrypted := GetEnglishUpper(Source);

    If EnglishEncrypted = '' Then
        Exit('');

    NumCols := Length(EnglishEncrypted);
    SetLength(Rail, NumRows, NumCols);

    For Row := 0 To NumRows - 1 Do
        For Col := 0 To NumCols - 1 Do
            Rail[Row, Col] := #0;

    Row := 0;
    DirDown := True;

    For Col := 0 to NumCols - 1 Do
    Begin
        Rail[Row, Col] := '*';

        If NumRows > 1 Then
        Begin
            If DirDown Then
                Inc(Row)
            Else
                Dec(Row);

            If Row = NumRows - 1 Then
                DirDown := False
            Else If Row = 0 Then
                DirDown := True;
        End;
    End;

    Index := 1;
    For Row := 0 To NumRows - 1 Do
        For Col := 0 To NumCols - 1 Do
            If (Rail[Row, Col] = '*') And (Index <= Length(EnglishEncrypted)) Then
            Begin
                Rail[Row, Col] := EnglishEncrypted[Index];
                Inc(Index);
            End;

    StringGrid.RowCount := NumRows;
    StringGrid.ColCount := NumCols;
    For Col := 0 To NumCols - 1 Do
        For Row := 0 To NumRows - 1 Do
            If Rail[Row, Col] <> #0 Then
                StringGrid.Cells[Col, Row] := Rail[Row, Col]
            Else
                StringGrid.Cells[Col, Row] := '';

    Result := '';

    Row := 0;
    DirDown := True;

    For Col := 0 To NumCols - 1 Do
    Begin
        Result := Result + Rail[Row, Col];

        If NumRows > 1 Then
        Begin
            If DirDown Then
                Inc(Row)
            Else
                Dec(Row);

            If Row = NumRows - 1 Then
                DirDown := False
            Else If Row = 0 Then
                DirDown := True;
        End;
    End;
End;


procedure TForm3.Button2Click(Sender: TObject);
var
    NumRows: Integer;
begin
    NumRows := StrToIntDef(ComboBox1.Text, 0);

    if (NumRows < 1) or (NumRows > 20) then
        Exit;

    Edit2.Text := EncryptRailFence(Edit1.Text, NumRows);

    StringGrid.Visible := True;
    StringGrid.Height := (StringGrid.RowCount + 1) * StringGrid.DefaultRowHeight;
    StringGrid.Width := (StringGrid.ColCount + 1) * StringGrid.DefaultColWidth;
    Button5.Enabled := True;
end;

procedure TForm3.Button3Click(Sender: TObject);
var
    NumRows: Integer;
begin
    NumRows := StrToIntDef(ComboBox1.Text, 0);

    if (NumRows < 1) or (NumRows > 20) then
    begin
        ShowMessage('Количество строк должно быть от 1 до 20');
        Exit;
    end;

    Edit2.Text := DecryptRailFence(Edit1.Text, NumRows);

    StringGrid.Visible := True;
    StringGrid.Height := (StringGrid.RowCount + 1) * StringGrid.DefaultRowHeight;
    StringGrid.Width := (StringGrid.ColCount + 1) * StringGrid.DefaultColWidth;
    Button5.Enabled := True;
end;


procedure TForm3.Button1Click(Sender: TObject);
var
    StringList: TStringList;
begin
    if OpenDialog.Execute then
    begin
        StringList := TStringList.Create;
        try
            StringList.LoadFromFile(OpenDialog.FileName);
            Edit1.Text := StringList.Text;
            Edit1Change(Sender);
        finally
            StringList.Free;
        end;
    end;
end;

procedure TForm3.Button4Click(Sender: TObject);
begin
    Edit1.Text := '';
    Edit2.Text := '';
    ComboBox1.ItemIndex := -1;
    Button2.Enabled := False;
    Button3.Enabled := False;
    StringGrid.Visible := False;
    Button5.Enabled := False;
end;

procedure TForm3.Button5Click(Sender: TObject);
var
    F: TextFile;
begin
    if Trim(Edit2.Text) = '' then
        Exit;

    SaveDialog1.Filter := 'Текстовые файлы (*.txt)|*.txt';
    SaveDialog1.DefaultExt := 'txt';
    SaveDialog1.FileName := 'result.txt';

    if SaveDialog1.Execute then
    begin
        AssignFile(F, SaveDialog1.FileName);
        Rewrite(F);
        try
            Write(F, Edit2.Text);
            ShowMessage('Файл успешно сохранён!');
        finally
            CloseFile(F);
        end;
    end;
end;

procedure TForm3.ComboBox1Change(Sender: TObject);
var
    NumRows: Integer;
begin
    NumRows := StrToIntDef(ComboBox1.Text, 0);

    Button2.Enabled := (NumRows >= 1) and (NumRows <= 20) and (Edit1.Text <> '');
    Button3.Enabled := Button2.Enabled;
end;

procedure TForm3.Edit1Change(Sender: TObject);
begin
    ComboBox1Change(Sender);
end;

end.

