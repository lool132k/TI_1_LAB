unit Unit3;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Grids;

type
  TForm3 = class(TForm)
    ComboBox1: TComboBox;
    Label1: TLabel;
    Button1: TButton;
    Label2: TLabel;
    Edit1: TEdit;
    Label3: TLabel;
    Edit2: TEdit;
    Button2: TButton;
    Button3: TButton;
    Button4: TButton;
    StringGrid: TStringGrid;
    OpenDialog: TOpenDialog;
    SaveDialog1: TSaveDialog;
    Button5: TButton;
    procedure Button2Click(Sender: TObject);
    procedure ComboBox1Change(Sender: TObject);
    procedure Edit1Change(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form3: TForm3;

implementation

{$R *.dfm}


procedure TForm3.Button1Click(Sender: TObject);
var
  StringList: TStringList;
begin
  if OpenDialog.Execute then
  begin
    StringList := TStringList.Create;
    try
      StringList.LoadFromFile(OpenDialog.FileName);
      Edit1.Text := StringList.Text;
      Edit1Change(Sender);

    finally
      StringList.Free;
    end;
  end;
end;

procedure TForm3.Button2Click(Sender: TObject);
var
  NumRows: Integer;
  Text, EnglishText: string;
  i: Integer;
  Row1, Col1, CharIndex: Integer;
  Dir: Boolean;
begin
  Text := Edit1.Text;
  Dir := True;

  EnglishText := '';
  for i := 1 to Length(Text) do
  begin
    if ((Text[i] >= 'A') and (Text[i] <= 'Z')) or
       ((Text[i] >= 'a') and (Text[i] <= 'z')) then
      EnglishText := EnglishText + Text[i];
  end;

  if EnglishText = '' then
    Exit;

  NumRows := StrToIntDef(ComboBox1.Text, 0);

  if (NumRows < 1) or (NumRows > 20) then
    Exit;

  StringGrid.RowCount := NumRows;
  StringGrid.ColCount := Length(EnglishText);

  for var Col := 0 to StringGrid.ColCount - 1 do
    for var Row := 0 to StringGrid.RowCount - 1 do
      StringGrid.Cells[Col, Row] := '';

  if NumRows = 1 then
    for i := 1 to Length(EnglishText) do
      StringGrid.Cells[i-1, 0] := EnglishText[i]
  else
  begin
    Row1 := 0;
    Col1 := 0;
    CharIndex := 1;
    While Col1 < StringGrid.ColCount Do
    Begin
      if CharIndex <= Length(EnglishText) then
        StringGrid.Cells[Col1, Row1] := EnglishText[CharIndex];

      Inc(CharIndex);

      If Dir Then
        Inc(Row1)
      Else
        Dec(Row1);

      If Row1 = StringGrid.RowCount - 1 Then
        Dir := False
      Else If Row1 = 0 Then
        Dir := True;

      Inc(Col1);
    End;
  end;

  var EncryptedText := '';
  for var Row := 0 to StringGrid.RowCount - 1 do
  begin
    for var Col := 0 to StringGrid.ColCount - 1 do
    begin
      if StringGrid.Cells[Col, Row] <> '' then
        EncryptedText := EncryptedText + StringGrid.Cells[Col, Row];
    end;
  end;

  Edit2.Text := EncryptedText;
  StringGrid.Height := (StringGrid.RowCount + 1) * StringGrid.DefaultRowHeight;
  StringGrid.Width := (StringGrid.ColCount + 1) * StringGrid.DefaultColWidth;
  StringGrid.Visible := True;
  Button5.Enabled := True;

  Label2.Caption := Format('Текст для шифрования: %d букв(ы) англ.', [Length(EnglishText)]);

end;

procedure TForm3.Button3Click(Sender: TObject);
var
  NumRows, NumCols: Integer;
  EncryptedText, EnglishEncrypted, DecryptedText: string;
  i, row, col, index: Integer;
  Rail: array of array of Char;
  dirDown: Boolean;
begin
  EncryptedText := Edit1.Text;

  if EncryptedText = '' then
    Exit;

  EnglishEncrypted := '';
  for i := 1 to Length(EncryptedText) do
    if CharInSet(EncryptedText[i], ['A'..'Z', 'a'..'z']) then
      EnglishEncrypted := EnglishEncrypted + EncryptedText[i];

  if EnglishEncrypted = '' then
    Exit;

  NumRows := StrToIntDef(ComboBox1.Text, 0);

  if (NumRows < 1) or (NumRows > 20) then
  begin
    ShowMessage('Количество строк должно быть от 1 до 20');
    Exit;
  end;

  NumCols := Length(EnglishEncrypted);

  SetLength(Rail, NumRows, NumCols);

  for row := 0 to NumRows-1 do
    for col := 0 to NumCols-1 do
      Rail[row, col] := #0;

  row := 0;
  dirDown := True;

  for col := 0 to NumCols-1 do
  begin
    Rail[row, col] := '*';

    if NumRows > 1 then
    begin
      if dirDown then
        Inc(row)
      else
        Dec(row);

      if row = NumRows-1 then
        dirDown := False
      else if row = 0 then
        dirDown := True;
    end;
  end;

  index := 1;

  for row := 0 to NumRows-1 do
    for col := 0 to NumCols-1 do
      if (Rail[row, col] = '*') and (index <= Length(EnglishEncrypted)) then
      begin
        Rail[row, col] := EnglishEncrypted[index];
        Inc(index);
      end;

  StringGrid.RowCount := NumRows;
  StringGrid.ColCount := NumCols;

  for col := 0 to NumCols-1 do
    for row := 0 to NumRows-1 do
      if Rail[row, col] <> #0 then
        StringGrid.Cells[col, row] := Rail[row, col]
      else
        StringGrid.Cells[col, row] := '';

  DecryptedText := '';

  row := 0;
  dirDown := True;

  for col := 0 to NumCols-1 do
  begin
    DecryptedText := DecryptedText + Rail[row, col];

    if NumRows > 1 then
    begin
      if dirDown then
        Inc(row)
      else
        Dec(row);

      if row = NumRows-1 then
        dirDown := False
      else if row = 0 then
        dirDown := True;
    end;
  end;

  Edit2.Text := DecryptedText;

  StringGrid.Visible := True;
  StringGrid.Height := (StringGrid.RowCount + 1) * StringGrid.DefaultRowHeight;
  StringGrid.Width := (StringGrid.ColCount + 1) * StringGrid.DefaultColWidth;
  Button5.Enabled := True;

end;


procedure TForm3.Button4Click(Sender: TObject);
begin
    Edit1.Text := '';
    Edit2.Text := '';
    ComboBox1.ItemIndex := -1;
    Button2.Enabled := False;
    Button3.Enabled := False;
    StringGrid.Visible := False;
    Button5.Enabled := False;
end;

procedure TForm3.Button5Click(Sender: TObject);
var
  F: TextFile;
begin
  if Trim(Edit2.Text) = '' then
    Exit;

  SaveDialog1.Filter := 'Текстовые файлы (*.txt)|*.txt';
  SaveDialog1.DefaultExt := 'txt';
  SaveDialog1.FileName := 'result.txt';

  if SaveDialog1.Execute then
  begin
    AssignFile(F, SaveDialog1.FileName);
    Rewrite(F);
    try
      Write(F, Edit2.Text);
      ShowMessage('Файл успешно сохранён!');
    finally
      CloseFile(F);
    end;
  end;
end;

procedure TForm3.ComboBox1Change(Sender: TObject);
var
  NumRows: Integer;
begin
  NumRows := StrToIntDef(ComboBox1.Text, 0);

  if (NumRows >= 1) and (NumRows <= 20) and (Edit1.Text <> '') then
  Begin
    Button2.Enabled := True;
    Button3.Enabled := True;
  End
  else
  Begin
    Button2.Enabled := False;
    Button3.Enabled := False;
  End;
end;

procedure TForm3.Edit1Change(Sender: TObject);
begin
    If Edit1.Text = '' Then
    Begin
        Button2.Enabled := False;
        Button3.Enabled := False;
    End
    else if (StrToIntDef(ComboBox1.Text, 0) >= 1) and
            (StrToIntDef(ComboBox1.Text, 0) <= 20) Then
    Begin
        Button2.Enabled := True;
        Button3.Enabled := True;
    End
    else
    Begin
        Button2.Enabled := False;
        Button3.Enabled := False;
    End;
end;

end.
